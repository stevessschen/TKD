# 金融異常交易偵測競賽

## 專案概述

本專案目標是基於帳戶交易網絡預測哪些帳戶將在未來 30 天（day 122-151）被標記為可疑帳戶。使用 day 1-121 的歷史交易資料，結合圖神經網絡（GCN）與變分自編碼器（VAE），最終在 Private Leaderboard 達成 **F1 Score 0.34**，進入前 20 強。

### 競賽數據
- **交易筆數**：4,435,890 筆
- **帳戶數量**：1,800,106 個
- **警示帳戶**：約 1,004 個
- **預測目標**：Day 122-151 被標記的帳戶

---

## 專案結構

```
project/
├── main.py                          # 主程序（訓練與預測流程）
├── Preprocess/
│   └── data_preprocess.py           # 特徵工程模組（27 維特徵提取）
├── Model/
│   └── model.py                     # GCN-VAE 模型與訓練
├── dataset/
│   ├── acct_transaction.csv         # 交易數據（day 1-121）
│   ├── acct_alert.csv               # 警示帳戶標籤
│   └── acct_predict.csv             # 待預測帳戶
└── output/
    └── predictions_plan1_temporal.csv  # 預測結果（F1 0.34）
```
## 使用方式
Python 3.10.12

1. git clone https://github.com/stevessschen/TKD.git
   
2. cd TKD

3. ** 安裝套件 ** => pip install -r requirements.txt

4. ** 準備資料 ** 請將以下三個CSV檔案放在 ./database/ 
- acct_transaction.csv
- acct_alert.csv
- acct_predict.csv

5. ** 執行程式 ** => python main.py (在cpu環境下執行約30分鐘)

6. 程式執行過程紀錄，請查看檔案：程式執行過程.txt

7. 預測結果將會儲存於 ./output/predictions_plan1_temporal.csv
---

## 資料分析與預處理

### 關鍵發現
1. **時間特性**：警示帳戶在被標記前（day 91-121）行為急劇變化
2. **網絡特性**：可疑帳戶通常位於網絡中心，PageRank 值異常高
3. **交易模式**：分散洗錢（高出度 + 規律金額）、集中詐欺（低出度 + 大額交易）

### 數據處理
- 帳戶編碼：字串 ID → 整數索引（1.8M 帳戶）
- 圖結構：無向圖，稀疏鄰接矩陣（3.5M 邊）
- 標籤建構：Hard Negative Mining（1:5 正負比）

---

## 特徵工程 ⭐ 核心創新

### 演進過程：從 10 維到 27 維

| 階段 | 特徵維度 | F1 Score | 關鍵特徵 |
|------|---------|----------|---------|
| **基礎版** | 10 維 | 0.18 | 度數、金額、自我交易、通道比例 |
| **第一次迭代** | 21 維 | 0.27 | + 時間模式（5 維）+ 交易模式（5 維）+ PageRank（1 維）|
| **第二次迭代** | 27 維 | 0.285 | + 時序窗口分析（6 維）⭐ |
| **Private Board** | 27 維 | **0.34** | 保留最重要的 27 個特徵 |

### 1. 基礎特徵（10 維）- F1 0.18
```python
特徵 1-3：度數統計（出度、入度、總度數）
特徵 4-5：交易金額（總支出、總收入）
特徵 6：自我轉帳比例（資金迴流異常）
特徵 7-8：帳戶類型偏好（type 01 比例）
特徵 9-10：交易通道偏好（channel 03/04 比例）
```

### 2. 時間與模式特徵（11 維）- F1 0.27 (+50%)
```python
時間特徵（5 維）：
- 夜間交易比例（22:00-06:00）→ 洗錢者避開監控
- 早晨、下午、晚間交易比例 → 識別異常時段模式
- 週末交易比例 → 正常用戶週末少交易

交易模式特徵（5 維）：
- 唯一交易對象數（出/入）→ 分散洗錢特徵
- 平均金額、金額標準差、最大金額 → 識別規律性異常

PageRank（1 維）：
- 網絡中心性 → 洗錢樞紐檢測
```

### 3. 時序窗口特徵（6 維）⭐ - F1 0.285 (+5.5%)

**核心創新**：比較早期（day 1-60）vs 晚期（day 91-121）行為變化

```python
特徵 21：頻率變化率 = 晚期頻率 / 早期頻率
  → 偵測「被標記前的活動激增」

特徵 22-23：晚期與早期的平均金額
  → 偵測「金額模式突變」

特徵 24-25：晚期與早期的交易頻率
  → 建立基準與異常對比

特徵 26：最後交易距離 day 121 的天數
  → 偵測「活躍到最後一刻」的帳戶
```

**優化技術**：使用 Numba JIT 編譯，30 分鐘 → 2 分鐘（15-20x 加速）

```

**效果**：
- 移除噪音特徵（如多樣性特徵導致過擬合）
- 提升泛化能力
- **F1 從 0.285 躍升至 0.34**

**Top 27 特徵** 包含：
- PageRank、加權 PageRank（網絡中心性）
- 總支出金額、總度數（規模指標）
- 頻率變化率、晚期金額（時序窗口）⭐
- 唯一交易對象數（行為多樣性）
- 自我轉帳比例（資金迴流）

---

## 建模概述 ⭐ 架構設計

### 模型架構：GCN-VAE

```
輸入層（27D/15D）
    ↓
GCN Layer 1 (128D) + ReLU + Dropout(0.5)
    ↓
GCN Layer 2 (64D) + ReLU + Dropout(0.5)
    ↓
GCN Layer 3 (32D) + ReLU + Dropout(0.5)
    ↓
    ├─→ GCN_μ (16D) ──┐
    └─→ GCN_logvar (16D) ──┤
                            ↓
                   Reparameterization (z ~ N(μ, σ²))
                            ↓
                   Linear Classifier → Sigmoid → Prediction
```

### 關鍵技術

#### 1. Hard Negative Mining
```python
正樣本：1,004 個警示帳戶
負樣本：5,020 個（1:5 比例）
  ├─ 50% 困難負樣本：特徵相似於正樣本（高相似度）
  └─ 50% 隨機負樣本：保持多樣性
```
**效果**：F1 0.18 → 0.27（+50%）

#### 2. Focal Loss（α=0.75, γ=2.0）
```python
FL = -α(1-p_t)^γ log(p_t)
```
- 自動降低簡單樣本權重
- 專注學習困難樣本
- 處理 1:5 類別不平衡

#### 3. 多目標損失函數
```python
L_total = L_recon + 0.3×L_KL + 5.0×L_focal

其中：
- L_recon：圖重建損失（學習網絡結構）
- L_KL：VAE 正則化（防止過擬合）
- L_focal：分類損失（異常檢測）
```

---

## 模型調整與成效評估

### 超參數調整

| 參數 | 初始值 | 最終值 | 影響 |
|-----|-------|--------|------|
| **Patience** | 15 | **30** | Early stopping，防止過擬合 |
| **Dropout** | 0.3 | **0.5** | 強正則化，提升泛化 |
| **KL Weight** | 0.5 | **0.3** | 平衡表達力與正則化 |
| **CLS Weight** | 3.0 | **5.0** | 加強分類目標權重 |
| **Focal Alpha** | 0.5 | **0.75** | 補償類別不平衡 |
| **Hidden Dims** | [64,32,16] | **[128,64,32,16]** | 增加模型容量 |

### 訓練策略
- **優化器**：Adam（lr=0.001, weight_decay=1e-4）
- **Batch 策略**：每 epoch 採樣 8000 條邊
- **Early Stopping**：驗證集 F1 連續 30 epoch 未提升則停止
- **閾值優化**：驗證集上搜索最佳分類閾值（0.1-0.9）

### F1 Score 演進歷程

```
┌─────────────────────────────────────────────────────────┐
│  F1 Score 提升路徑（0.18 → 0.34，+89% 相對提升）        │
├─────────────────────────────────────────────────────────┤
│                                                           │
│  0.18 ▓░░░░░░░░  基礎 GAE（10 維特徵）                  │
│       ↓ +Hard Negative Mining                            │
│  0.27 ▓▓▓▓▓▓░░░  +時間/模式/PageRank（21 維）           │
│       ↓ +時序窗口特徵                                    │
│  0.285 ▓▓▓▓▓▓▓░░  +早期 vs 晚期行為分析（27 維）        │
│       ↓ 特徵選擇                               │
│  0.34 ▓▓▓▓▓▓▓▓▓  保留 27 特徵（最終版）⭐          │
│                                                           │
└─────────────────────────────────────────────────────────┘
```

---

## 實驗結果

### 最終成績
- **Private Leaderboard F1 Score**: **0.34**
- **排名**：前 20 強
- **驗證集表現**：
  - Precision: 0.9126
  - Recall: 0.8789
  - F1 Score: 0.8954

### 關鍵成功因素
1. **時序窗口特徵**：捕捉被標記前的行為變化（+5.5% F1）
2. **特徵選擇**：移除噪音，提升泛化（+19.3% F1）
3. **Hard Negative Mining**：學習困難樣本（+50% F1）
4. **參數精調**：Patience=30, Dropout=0.5 等（穩定提升）

---

## 未來改進方向

### 短期優化
1. **時間序列建模**：LSTM/Transformer 捕捉更複雜的時序模式
2. **圖 Attention 機制**：GAT 替代 GCN，自適應鄰居權重
3. **集成學習**：多模型投票提升穩定性

### 長期探索
1. **動態圖神經網絡**：考慮交易的時間順序
2. **異質圖建模**：整合帳戶類型、通道、貨幣等異質信息
3. **對比學習**：無監督預訓練提升特徵質量
4. **可解釋性分析**：SHAP/GNNExplainer 解釋模型決策

---

## 結論與參賽心得

### 技術收穫
1. **特徵工程的重要性**：好的特徵勝過複雜的模型
   - 時序窗口特徵的創新是突破 F1 0.30 的關鍵
   - 特徵選擇比特徵數量更重要

2. **圖神經網絡的實戰應用**：
   - GCN 能有效捕捉交易網絡的結構信息
   - VAE 正則化防止過擬合，提升泛化

3. **數據不平衡處理**：
   - Hard Negative Mining + Focal Loss 是有效組合
   - 需要在樣本平衡與真實分佈間取得平衡

### 競賽策略
- **快速迭代**：每次只改進一個方面，方便定位問題
- **數據驅動**：透過 EDA 發現時序窗口的重要性
- **工程優化**：Numba 加速使得大規模實驗成為可能

### 個人成長
參加競賽不僅提升了機器學習技術，更學會了：
- 系統化的實驗設計與記錄
- 在有限資源下的優化策略
- 從數據中挖掘領域知識的能力

感謝主辦單位提供這個寶貴的學習機會！

---

## 參考資料

1. Kipf, T. N., & Welling, M. (2016). Variational Graph Auto-Encoders. *NIPS Workshop*.
2. Lin, T. Y., et al. (2017). Focal Loss for Dense Object Detection. *ICCV*.
3. Kingma, D. P., & Welling, M. (2013). Auto-Encoding Variational Bayes. *ICLR*.

---
